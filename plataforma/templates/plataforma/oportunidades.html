{% extends "plataforma/base.html" %}

{% block title %}Oportunidades de Empleo{% endblock %}

{% block content %}
<!-- Token CSRF oculto para asegurar que la cookie exista -->
<div style="display:none;">{% csrf_token %}</div>

<div class="container">
    <div class="card" style="background: linear-gradient(135deg, #006837 0%, #2d5016 100%); color: white; border: none; margin-bottom: 2rem;">
        <div style="text-align: center; padding: 2rem;">
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üíº Oportunidades de Aprendizaje</h1>
            <p style="opacity: 0.9; font-size: 1.1rem;">Explora las empresas disponibles y post√∫late a tu pr√°ctica ideal</p>
        </div>
    </div>

    <!-- Buscador -->
    <div style="margin-bottom: 2rem;">
        <input type="text" id="buscador" placeholder="üîç Buscar empresa, cargo o ubicaci√≥n..." 
               style="padding: 1rem; border-radius: 50px; border: 1px solid #ddd; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 1rem;">
    </div>

    <!-- Grid de Oportunidades -->
    <div id="lista-oportunidades" class="grid">
        <!-- Se llena con JS -->
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p style="color: #666; margin-top: 1rem;">Cargando ofertas disponibles...</p>
        </div>
    </div>
</div>

<!-- SweetAlert2 para ventanas flotantes -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        cargarOportunidades();

        // Buscador en tiempo real
        document.getElementById('buscador').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.oportunidad-card');
            
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        });
    });

    function cargarOportunidades() {
        fetch('/api/oportunidades/')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('lista-oportunidades');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; background: white; border-radius: 10px;">
                            <h3>No hay ofertas disponibles por el momento üòî</h3>
                            <p>Intenta nuevamente m√°s tarde.</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(empresa => {
                    const card = document.createElement('div');
                    card.className = 'card oportunidad-card';
                    card.style = 'border-top: 4px solid #006837; transition: transform 0.2s;';
                    card.onmouseover = function() { this.style.transform = 'translateY(-5px)'; }
                    card.onmouseout = function() { this.style.transform = 'translateY(0)'; }
                    
                    // L√≥gica de cupos
                    let badgeCupos = '';
                    let btnDisabled = '';
                    let btnText = '‚úÖ Postularme';
                    let btnClass = 'btn-primary';

                    if (empresa.cupos_disponibles > 0) {
                        badgeCupos = `<span class="badge badge-success">${empresa.cupos_disponibles} cupos disponibles</span>`;
                    } else {
                        badgeCupos = `<span class="badge badge-danger">Oferta caducada</span>`;
                        btnDisabled = 'disabled';
                        btnText = 'Sin cupos';
                        btnClass = 'btn-secondary';
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h2 style="margin: 0; color: #006837; font-size: 1.5rem;">${empresa.nombre}</h2>
                            ${badgeCupos}
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: #555; line-height: 1.6; margin-bottom: 1rem;">${empresa.descripcion}</p>
                            
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                                <div style="margin-bottom: 0.5rem;"><strong>üìç Ubicaci√≥n:</strong> ${empresa.direccion}</div>
                                <div style="margin-bottom: 0.5rem;"><strong>üìß Contacto:</strong> ${empresa.correo}</div>
                                <div><strong>üìû Tel√©fono:</strong> ${empresa.telefono}</div>
                            </div>
                        </div>

                        <div style="margin-top: auto; border-top: 1px solid #eee; padding-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <small style="color: #999;">NIT: ${empresa.nit}</small>
                            <button onclick="enviarPostulacion(${empresa.id})" 
                                    class="btn ${btnClass}" ${btnDisabled} style="width: auto; margin: 0;">
                                ${btnText}
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
    }

    // Hacer la funci√≥n global para que el onclick funcione
    window.enviarPostulacion = function(empresaId) {
        const csrftoken = getCookie('csrftoken');
        
        fetch('/api/postularse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ empresa_id: empresaId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: '¬°Postulaci√≥n Exitosa!',
                    text: 'Por favor recuerde que solo se puede postular a una empresa a la vez y en un rango de 15 d√≠as.',
                    icon: 'success',
                    confirmButtonColor: '#006837'
                }).then(() => {
                    window.location.href = '/mis-postulaciones/';
                });
            } else {
                Swal.fire({
                    title: 'No se pudo realizar la postulaci√≥n',
                    text: data.message, // Mensaje din√°mico desde el backend (ej: regla de 15 d√≠as)
                    icon: 'warning',
                    confirmButtonColor: '#f59e0b'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Ocurri√≥ un error al intentar postularse. Por favor recarga la p√°gina e intenta nuevamente.',
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        });
    };

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}